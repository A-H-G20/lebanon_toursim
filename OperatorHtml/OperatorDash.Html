<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Package Management</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=Playfair+Display:wght@500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../OperatorCSS/operatorDash.css" />
  </head>
  <body>
    <div class="dashboard-container">
      <div class="menu-overlay" onclick="closeMobileMenu()"></div>
      <button class="menu-toggle" id="menuToggle">
        <span></span>
        <span></span>
        <span></span>
      </button>

      <nav class="sidebar" id="sidebar">
        <div class="nav__logo">
          <h2>Tourism</h2>
        </div>
        <div
          class="nav-item"
          onclick="window.location.href='../OperatorHtml/operatorDash.html'"
        >
          <i class="fas fa-box"></i>
          <span>Packages</span>
        </div>
        <div
          class="nav-item"
          onclick="window.location.href='../OperatorHtml/bookinDash.html'"
        >
          <i class="fas fa-users"></i>
          <span>Booking</span>
        </div>

        <div
          class="nav-item"
          onclick="window.location.href='../OperatorHtml/notficationDash.html'"
        >
          <i class="fas fa-cog"></i>
          <span>Notification</span>
        </div>

        <div
          class="nav-item"
          onclick="window.location.href='../UserHtml/loginPage.html'"
        >
          <i class="fas fa-door-open"></i>
          <span>Logout</span>
        </div>
      </nav>

      <main class="main-content">
        <div class="header">
          <div class="header-left">
            <h1>Manage Packages</h1>
            <div class="search-bar">
              <input
                type="text"
                id="searchInput"
                placeholder="Search packages by name, type, activity..."
              />
              <i class="fas fa-search"></i>
            </div>
          </div>
          <button class="btn-primary" onclick="togglePackageModal()">
            <i class="fas fa-plus"></i> Create New
          </button>
        </div>

        <div class="package-grid" id="packageContainer"></div>

        <div class="package-modal" id="packageModal">
          <div class="modal-content">
            <button
              class="btn-primary"
              onclick="togglePackageModal()"
              style="position: absolute; right: 1rem; top: 1rem"
            >
              <i class="fas fa-times"></i>
            </button>
            <h2 id="modalTitle">Create New Package</h2>
            <form id="packageForm">
              <input type="hidden" id="packageId" name="id" />
              <div class="form-grid">
                <div class="form-group">
                  <label>Package Title</label>
                  <input type="text" name="title" required />
                </div>
                <div class="form-group">
                  <label>Status</label>
                  <select name="status" required>
                    <option value="active">Active</option>
                    <option value="draft">Draft</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>Package Type</label>
                  <select name="type" required>
                    <option value="adventure">Adventure</option>
                    <option value="cultural">Cultural</option>
                    <option value="luxury">Luxury</option>
                    <option value="family">Family</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>Activity Level</label>
                  <select name="activityLevel" required>
                    <option value="easy">Easy</option>
                    <option value="moderate">Moderate</option>
                    <option value="challenging">Challenging</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>Location</label>
                  <input type="text" name="location" required />
                </div>
                <div class="form-group">
                  <label>Start Date</label>
                  <input type="date" name="startDate" required />
                </div>
                <div class="form-group">
                  <label>End Date</label>
                  <input type="date" name="endDate" required />
                </div>
                <div class="form-group">
                  <label>Price per Person</label>
                  <input type="number" name="price" required />
                </div>
                <div class="form-group">
                  <label>Max Participants</label>
                  <input type="number" name="maxParticipants" required />
                </div>

                <div class="form-group">
                  <label>Package Description</label>
                  <textarea name="description" rows="4"></textarea>
                </div>
              </div>
              <div class="form-group">
                <label>Daily Itinerary</label>
                <div id="itineraryContainer">
                  <div class="itinerary-day">
                    <input
                      type="text"
                      name="dayTitle[]"
                      placeholder="Day 1 Title"
                      required
                    />
                    <textarea
                      name="dayDescription[]"
                      rows="2"
                      placeholder="Day 1 Description"
                      required
                    ></textarea>
                  </div>
                </div>
                <button
                  type="button"
                  class="btn-primary add-day-btn"
                  onclick="addItineraryDay()"
                >
                  <i class="fas fa-plus"></i> Add Day
                </button>
              </div>

              <div class="form-group">
                <label>Package Images</label>
                <input
                  type="file"
                  id="imageUpload"
                  multiple
                  accept="image/*"
                  onchange="handleImageUpload()"
                />
                <div class="image-preview" id="imagePreview"></div>
              </div>
              <div style="display: flex; gap: 1rem; margin-top: 2rem">
                <button type="submit" class="btn-primary">
                  <i class="fas fa-save"></i> Save Package
                </button>
                <button
                  type="button"
                  class="btn-primary"
                  style="background: var(--text-light)"
                  onclick="togglePackageModal()"
                >
                  Cancel
                </button>
              </div>
            </form>
          </div>
        </div>
      </main>
    </div>
    <script>
      const menuToggle = document.getElementById("menuToggle");
      const sidebar = document.getElementById("sidebar");

      menuToggle.addEventListener("click", (e) => {
        e.stopPropagation();
        sidebar.classList.toggle("active");
        menuToggle.classList.toggle("active");
      });

      document.addEventListener("click", (e) => {
        if (window.innerWidth <= 768) {
          if (!sidebar.contains(e.target) && !menuToggle.contains(e.target)) {
            sidebar.classList.remove("active");
            menuToggle.classList.remove("active");
          }
        }
      });

      window.addEventListener("resize", () => {
        if (window.innerWidth > 768) {
          sidebar.classList.remove("active");
          menuToggle.classList.remove("active");
        }
      });
      document
        .getElementById("searchInput")
        .addEventListener("input", function (e) {
          const searchTerm = e.target.value.toLowerCase();
          filterPackages(searchTerm);
        });

      function filterPackages(searchTerm) {
        const filtered = packages.filter((pkg) => {
          return (
            pkg.title.toLowerCase().includes(searchTerm) ||
            pkg.location.toLowerCase().includes(searchTerm) ||
            pkg.description.toLowerCase().includes(searchTerm) ||
            pkg.type.toLowerCase().includes(searchTerm) ||
            pkg.activityLevel.toLowerCase().includes(searchTerm)
          );
        });
        renderPackages(filtered);
      }
      let packages = JSON.parse(localStorage.getItem("tourPackages")) || [];
      let currentEditId = null;

      document.addEventListener("DOMContentLoaded", () => {
        renderPackages();
        document
          .getElementById("packageForm")
          .addEventListener("submit", handleFormSubmit);
      });

      async function handleFormSubmit(e) {
        e.preventDefault();
        const formData = new FormData(e.target);

        // Handle images
        const imageFiles = document.getElementById("imageUpload").files;
        const images = await Promise.all(
          Array.from(imageFiles).map(
            (file) =>
              new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.readAsDataURL(file);
              })
          )
        );

        const packageData = {
          ...Object.fromEntries(formData.entries()),
          itinerary: Array.from(formData.getAll("dayTitle[]")).map(
            (title, index) => ({
              title,
              description: formData.getAll("dayDescription[]")[index],
            })
          ),
          images,
          price: Number(formData.get("price")),
          maxParticipants: Number(formData.get("maxParticipants")),
          booked: currentEditId
            ? packages.find((p) => p.id === currentEditId).booked
            : 0,
          id: currentEditId || Date.now().toString(),
        };

        if (currentEditId) {
          const index = packages.findIndex((p) => p.id === currentEditId);
          packages[index] = packageData;
        } else {
          packages.push(packageData);
        }

        localStorage.setItem("tourPackages", JSON.stringify(packages));
        togglePackageModal();
        renderPackages();
        resetForm();
      }

      function renderPackages(packagesToRender = packages) {
        const container = document.getElementById("packageContainer");
        container.innerHTML = "";

        packagesToRender.forEach((pkg) => {
          const packageElement = document.createElement("div");
          packageElement.className = "package-card";
          packageElement.innerHTML = `
                           <span class="package-type">${pkg.type}</span>
                           <span class="package-status ${
                             pkg.status === "active"
                               ? "status-active"
                               : "status-draft"
                           }">
                               ${pkg.status}
                           </span>
                           ${
                             pkg.images?.length
                               ? `<img src="${pkg.images[0]}" class="package-image" alt="${pkg.title}">`
                               : ""
                           }
                           <h3>${pkg.title}</h3>
                           <div class="activity-level">
                               <i class="fas fa-hiking"></i> ${
                                 pkg.activityLevel
                               }
                           </div>
                           <div class="package-meta">
                               <span><i class="fas fa-calendar"></i> ${formatDates(
                                 pkg.startDate,
                                 pkg.endDate
                               )}</span>
                               <span>$${pkg.price}/person</span>
                           </div>
                           ${
                             pkg.itinerary?.length
                               ? `
                           <div class="itinerary-preview">
                               ${pkg.itinerary
                                 .slice(0, 2)
                                 .map(
                                   (day) => `
                                   <div class="itinerary-day">
                                       <h4>${day.title}</h4>
                                       <p>${day.description.substring(
                                         0,
                                         80
                                       )}...</p>
                                   </div>
                               `
                                 )
                                 .join("")}
                           </div>`
                               : ""
                           }
                           <div class="package-stats">
                               <div class="stat-item">
                                   <div class="stat-value">${pkg.booked || 0}/${
            pkg.maxParticipants
          }</div>
                                   <div class="stat-label">Booked</div>
                               </div>
                               <div class="stat-item">
                                   <div class="stat-value">$${
                                     (pkg.booked || 0) * pkg.price
                                   }</div>
                                   <div class="stat-label">Revenue</div>
                               </div>
                           </div>
                           <div class="package-actions">
                               <button class="btn-primary edit-btn" onclick="editPackage('${
                                 pkg.id
                               }')">
                                   <i class="fas fa-edit"></i> Edit Package
                               </button>
                               <button class="btn-primary edit-btn" onclick="deletePackage('${
                                 pkg.id
                               }')">
                                   <i class="fas fa-trash"></i> Delete
                               </button>
                           </div>
                       `;
          container.appendChild(packageElement);
        });
      }
      function addItineraryDay() {
        const container = document.getElementById("itineraryContainer");
        const dayNumber = container.children.length + 1;
        const dayDiv = document.createElement("div");
        dayDiv.className = "itinerary-day";
        dayDiv.innerHTML = `
            <input type="text" name="dayTitle[]" placeholder="Day ${dayNumber} Title" required>
            <textarea name="dayDescription[]" rows="2" 
                      placeholder="Day ${dayNumber} Description" required></textarea>
        `;
        container.appendChild(dayDiv);
      }

      function editPackage(id) {
        const pkg = packages.find((p) => p.id === id);
        if (!pkg) return;

        const form = document.getElementById("packageForm");
        document.getElementById("itineraryContainer").innerHTML = "";

        // Populate form fields
        form.elements.id.value = pkg.id;
        form.elements.title.value = pkg.title;
        form.elements.location.value = pkg.location;
        form.elements.startDate.value = pkg.startDate;
        form.elements.endDate.value = pkg.endDate;
        form.elements.price.value = pkg.price;
        form.elements.maxParticipants.value = pkg.maxParticipants;
        form.elements.description.value = pkg.description || "";
        form.elements.status.value = pkg.status;
        form.elements.type.value = pkg.type;
        form.elements.activityLevel.value = pkg.activityLevel;

        // Add itinerary days
        if (pkg.itinerary) {
          pkg.itinerary.forEach((day, index) => {
            const dayDiv = document.createElement("div");
            dayDiv.className = "itinerary-day";
            dayDiv.innerHTML = `
                    <input type="text" name="dayTitle[]" 
                           value="${day.title}" placeholder="Day ${
              index + 1
            } Title" required>
                    <textarea name="dayDescription[]" rows="2" 
                              placeholder="Day ${
                                index + 1
                              } Description" required>${
              day.description
            }</textarea>
                `;
            document.getElementById("itineraryContainer").appendChild(dayDiv);
          });
        }

        const preview = document.getElementById("imagePreview");
        preview.innerHTML = "";
        if (pkg.images) {
          pkg.images.forEach((imageSrc) => {
            const div = document.createElement("div");
            div.className = "image-preview-item";
            div.innerHTML = `<img src="${imageSrc}">`;
            preview.appendChild(div);
          });
        }

        currentEditId = id;
        document.getElementById("modalTitle").textContent = "Edit Package";
        togglePackageModal();
      }

      function deletePackage(id) {
        packages = packages.filter((p) => p.id !== id);
        localStorage.setItem("tourPackages", JSON.stringify(packages));
        renderPackages();
      }

      function togglePackageModal() {
        const modal = document.getElementById("packageModal");
        modal.style.display =
          modal.style.display === "block" ? "none" : "block";

        if (modal.style.display === "block") {
          document.querySelector(".modal-content").scrollTop = 0;
        } else {
          resetForm();
        }
      }

      function resetForm() {
        document.getElementById("packageForm").reset();
        document.getElementById("itineraryContainer").innerHTML = `
            <div class="itinerary-day">
                <input type="text" name="dayTitle[]" placeholder="Day 1 Title" required>
                <textarea name="dayDescription[]" rows="2" 
                          placeholder="Day 1 Description" required></textarea>
            </div>
        `;
        document.getElementById("imagePreview").innerHTML = "";
        currentEditId = null;
        document.getElementById("modalTitle").textContent =
          "Create New Package";
        document.getElementById("searchInput").value = "";
      }

      function formatDates(start, end) {
        const options = { day: "numeric", month: "short" };
        const startDate = new Date(start).toLocaleDateString("en-US", options);
        const endDate = new Date(end).toLocaleDateString("en-US", options);
        return `${startDate} - ${endDate}`;
      }
    </script>
  </body>
</html>
